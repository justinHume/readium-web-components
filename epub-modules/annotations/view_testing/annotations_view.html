<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="../css/annotations.css">
        <script src="../lib/jquery-1.9.1.js" type="text/javascript"></script>
        <script src="../lib/modernizr-2.5.3.min.js" type="text/javascript"></script>
        <script src="../lib/json2.js" type="text/javascript"></script>
        <script src="../lib/underscore.js" type="text/javascript"></script>
        <script src="../lib/backbone.js" type="text/javascript"></script>
        <script src="../lib/URI.js" type="text/javascript"></script>
        <script src="../epub_reflowable_module.js" type="text/javascript"></script>
        <script src="../epub_reader_module.js" type="text/javascript"></script>
        <script src="initialization_test.js" type="text/javascript"></script>
        <script src="../epub_cfi.js" type="text/javascript"></script>
        <script src="../epub_annotations_module.js" type="text/javascript"></script>

        <script type="text/javascript">

            $(document).ready(function () {

                var that = this;
                this.view = initializationTest();

                this.view.on("epubLoaded", function () { 

                    this.view.showSpineItem(2);

                    // Show annotations
                    var visibleIframe = $($(".flowing-wrapper")[2]).children()[0];
                    var iframeOffsetTop = $(visibleIframe).offset().top;
                    var iframeOffsetLeft = $(visibleIframe).offset().left;
                    this.annotations = new EpubAnnotationsModule(
                        iframeOffsetTop, 
                        iframeOffsetLeft,
                        $("#reader")[0]
                    );

                    // Get target element
                    var epubContentDocument = visibleIframe.contentDocument;
                    var $targetElement = $($("#building_a_better_epub", epubContentDocument).children()[2]);

                    $("#highlight").on("click", function () {

                        var highlightChildren = $("#building_a_better_epub").children();
                        var selectedElements = []; 
                        $.each(highlightChildren, function (child) {
                            selectedElements.push(child[0]);
                        });
                        that.annotations.addHighlight("epubcfi(/2/2/2)", selectedElements, "10");
                    });

                    $("#bookmark").on("click", function () {

                        that.view.addSelectionBookmark("10");
                    });

                    $("#add-bookmark").on("click", function () {

                        var cfi = "epubcfi(/6/24!/4/2/4/1:10)";
                        var annotationInfo = that.view.addBookmark(cfi, "10", function (errors, contentDocSpineIndex, CFI, annotationInfo) {
                            console.log("highlight 11 added");
                        }, this);
                    });

                    $("#add-highlight").on("click", function () {

                        var cfi = "epubcfi(/6/24!/4/2,/4/1:10,/6/1:20)";
                        var annotationInfo = that.view.addHighlight(cfi, "11", function (errors, contentDocSpineIndex, CFI, annotationInfo) {
                            console.log("highlight 11 added");
                        }, this);
                    });

                }, this);

                this.view.render();
            });

        </script>
    </head>
    <body>
        <button id="highlight">highlight</button>
        <button id="bookmark">bookmark</button>
        <button id="add-bookmark">add bookmark</button>
        <button id="add-highlight">add highlight</button>
        <div id="reader" style="height:600px; width:100%">
        </div>
    </body>
</html>